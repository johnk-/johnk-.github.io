<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Semantics and Optimization of Copying Function Bodies - #2 by hostilefork - Optimization - AltRebol</title>
    <meta name="description" content="Part of Rebol&amp;#39;s design is that every execution frame has an order to its arguments, represented by an integer. 
So for instance with IF: 

the CONDITION would be in frame cell[1]

the BRANCH would be in frame cell[2]



N&amp;hellip;">
    <meta name="generator" content="Discourse 3.4.0.beta3-dev - https://github.com/discourse/discourse version 93983286b54a0e96b8073abce23f4566e9f296f7">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" media="all" content="#ffffff">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../2119.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="AltRebol Search">

    <link href="https://forum.rebol.info/stylesheets/color_definitions_base__2_b36da8919caf93960d3b4470a90d0e79c6a110e2.css?__ws=forum.rebol.info" media="all" rel="stylesheet" class="light-scheme"/>

  <link href="https://forum.rebol.info/stylesheets/desktop_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop"  />



  <link href="https://forum.rebol.info/stylesheets/chat_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="chat"  />
  <link href="https://forum.rebol.info/stylesheets/checklist_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="checklist"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-details_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-details"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-lazy-videos_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-local-dates_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-narrative-bot_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-presence_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-presence"  />
  <link href="https://forum.rebol.info/stylesheets/docker_manager_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="docker_manager"  />
  <link href="https://forum.rebol.info/stylesheets/footnote_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="footnote"  />
  <link href="https://forum.rebol.info/stylesheets/poll_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="poll"  />
  <link href="https://forum.rebol.info/stylesheets/spoiler-alert_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="spoiler-alert"  />
  <link href="https://forum.rebol.info/stylesheets/chat_desktop_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="chat_desktop"  />
  <link href="https://forum.rebol.info/stylesheets/poll_desktop_eb475c67ca07665cb858ddf2ea6c953c2e3e2b85.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="poll_desktop"  />

  <link href="https://forum.rebol.info/stylesheets/desktop_theme_2_bac9ab3eace9fe3f17026a3c4dbf25e3e9e1e9a0.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2" data-theme-name="default"/>

    
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Semantics and Optimization of Copying Function Bodies&#39;" href="../2119.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/semantics-and-optimization-of-copying-function-bodies/2119/2" />
<meta name="twitter:url" content="https://forum.rebol.info/t/semantics-and-optimization-of-copying-function-bodies/2119/2" />
<meta property="og:title" content="Semantics and Optimization of Copying Function Bodies" />
<meta name="twitter:title" content="Semantics and Optimization of Copying Function Bodies" />
<meta property="og:description" content="If this optimization is going to work, then it also needs a complement to the &quot;unbounds optimized to find their membership in the frame, if you ask&quot;... which is &quot;unbounds optimized to NOT find their membership in the frame, if you ask&quot;.  Consider this:   y: &lt;something&gt;   foo: func [x &lt;local&gt; a b c d e f g h i j ...] [  ; imagine costly to lookup      code: copy [add x]      append code to word! &quot;x&quot;      do code  ]  The [add x] block gets bound to the environment before it is passed to COPY.  Th..." />
<meta name="twitter:description" content="If this optimization is going to work, then it also needs a complement to the &quot;unbounds optimized to find their membership in the frame, if you ask&quot;... which is &quot;unbounds optimized to NOT find their membership in the frame, if you ask&quot;.  Consider this:   y: &lt;something&gt;   foo: func [x &lt;local&gt; a b c d e f g h i j ...] [  ; imagine costly to lookup      code: copy [add x]      append code to word! &quot;x&quot;      do code  ]  The [add x] block gets bound to the environment before it is passed to COPY.  Th..." />
<meta property="og:article:section" content="Development" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="og:article:section" content="Optimization" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="article:published_time" content="2024-01-18T14:56:52+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    
    <header>
  <a href="https://forum.rebol.info/">
    AltRebol
  </a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="../2119.html">Semantics and Optimization of Copying Function Bodies</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/optimization/53" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/optimization/53" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Optimization</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  

    <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Semantics and Optimization of Copying Function Bodies'>
      <link itemprop='url' href='../2119.html'>
      <meta itemprop='datePublished' content='2024-01-16T09:00:09Z'>
        <meta itemprop='articleSection' content='Optimization'>
      <meta itemprop='keywords' content=''>
      <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
        <meta itemprop='name' content='AltRebol'>
          <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
            <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
          </div>
      </div>

          <span itemprop='author' itemscope itemtype="http://schema.org/Person">
            <meta itemprop='name' content='hostilefork'>
            <link itemprop='url' href='https://forum.rebol.info/u/hostilefork'>
          </span>
        <meta itemprop='text' content='Part of Rebol&amp;#39;s design is that every execution frame has an order to its arguments, represented by an integer. 
So for instance with IF: 

the CONDITION would be in frame cell[1]

the BRANCH would be in frame cell[2]



N&amp;hellip;'>

          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2024-01-18T14:56:52Z' class='post-time'>
                    January 18, 2024,  2:56pm
                  </time>
                  <meta itemprop='dateModified' content='2024-01-18T16:10:21Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <aside class="quote no-group" data-username="hostilefork" data-post="1" data-topic="2119">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="../../../user_avatar/forum.rebol.info/hostilefork/48/421_2.png" class="avatar"> hostilefork:</div>
<blockquote>
<p>The bias in the new proposal of binding is that any WORD!s already bound will be left-as is, with only some minor surgery on environments of blocks done by things like FUNC or FOR-EACH, to inject some new variables at the head of the lookup.</p>
<p>That may make it sound like these words which are bound relatively inside function bodies are more trouble than they are worth. In the model, they're actually supposed to be thought of as unbound--so if they carry a secret binding, that could only be used as an optimization when they are actually intentionally combined with the right frame.</p>
</blockquote>
</aside>
<p>If this optimization is going to work, then it also needs a complement to the <em>"unbounds optimized to find their membership in the frame, if you ask"</em>... which is <em>"unbounds optimized to NOT find their membership in the frame, if you ask"</em>.</p>
<p>Consider this:</p>
<pre><code> y: &lt;something&gt;

 foo: func [x &lt;local&gt; a b c d e f g h i j ...] [  ; imagine costly to lookup
     code: copy [add x]
     append code to word! "x"
     do code
 ]
</code></pre>
<p>The <strong>[add x]</strong> block gets bound to the environment before it is passed to COPY.  That environment can find X and Y and ADD and whatever else.</p>
<p>What we're talking about in the optimization is that when the function body was copied, the X of [add x] got a binding pasted on it to say <em>"if you try and look X up in a frame instance for the foo function, here's the index of X...you don't have to look"</em>.  The index and the pointer to the function definition can fit in the cell.</p>
<p>But that X is conceptually unbound.  There's no reason the other appended X that has no binding whatsoever shouldn't be found just as legitimately as it.  (I used TO WORD! "X" here instead of just 'X because quoted things would need to be labeled with the lookup optimization too...or at least not labeled with the negative optimization.  Again, it's conceptually still unbound.  But if you convert a string to a word at runtime, there's no optimization there.)</p>
<p>By extension, <em>all</em> unbound material needs to be considered in the search when the frame is in the specifier.  You can't rule out looking to see if ADD is in the frame just because it doesn't have the optimization applied, for the same reason you can't rule out looking for the no-optimized-binding X.</p>
<p>So that's why I mention the negative hint.  All unbound material that's <em>not</em> in the frame during the copy would be tagged with the action definition to say "don't bother looking me up in the environment for a frame instance of this action".</p>
<p>Dynamic material run with the frame context applied that's unbound won't have this information.  But if it's unbound, there's no harm in having the lookup cache the information about whether the lookup succeeded or not.  Only one frame lookup can win, so it would either need to be sticky with the first lookup done or re-cache (based on last lookup, or maybe if a frame comes along that's bigger than the one cached...)</p>
<p>Note that what this is replacing was a model by which bindings would be fully "hardened" inside the function body during the copy.  So everything in the body would point directly (or relatively) at what it needed to look up to, giving speed in future runs (modulo the various "overbindings" that would override bindings for things like loop variables during a FOR-EACH, etc.)</p>
<p>So the example I cite would not work (it would work if you used <strong>'x</strong> instead of <strong>to word! "x"</strong>):</p>
<pre><code> foo: func [x] [
     code: copy [add x]
     append code to word! "x"
     do code
 ]

&gt;&gt; foo 10
** Script Error: x word is not bound to a context
</code></pre>
<p>Should be able to make it work in the new model, without needing to explicitly bind the word to the frame instance.</p>
<p>Keeping the body mostly unbound across every run has nice properties, but it'll be slow without some tricks like this optimization in play.</p>
<h2><a name="p-7000-another-argument-for-the-member-selection-notation-1" class="anchor" href="2.html#p-7000-another-argument-for-the-member-selection-notation-1"></a>...Another Argument For The <strong><code>.member</code></strong> Selection Notation</h2>
<p>With binding being purely virtual, there's competition not just from multiple frames (e.g. nested functions) over the same cell's cache, but also lookups for object members.</p>
<p>This seems to make an interesting case for being able to tell from the value itself if it needs to be looked up in an object.</p>
<p>Without that:</p>
<pre><code> o: make object! [
     field1: &lt;one&gt;
     field2: &lt;two&gt;
     ...  ; imagine a non-trivial number of fields
     foo: method [arg1 arg2] [
         return reduce [arg1 field1 arg2 field2]
     ]
 ]
</code></pre>
<p>When that method runs, it gets a specifier for the object instance and for the frame of FOO.  So if we label everything in the body that gets copied as either "unbound, but findable in foo frames" or "unbound, and NOT findable in foo frames"... that's used up all the cache space in the cells.</p>
<p>But if we know that <strong>.xxx</strong> will never look up to a function argument, but only in the members, the caching can be saved relative to the object prototype.</p>
<pre><code> o: new object [  ; something where FIELD1 and FIELD2 don't bind deeply
     field1: &lt;one&gt;
     field2: &lt;two&gt;
     ...  ; imagine a non-trivial number of fields
     foo: method [arg1 arg2] [
         return reduce [arg1 .field1 arg2 .field2]
     ]
 ]
</code></pre>
<p>This is on top of the benefit I've already mentioned of "giving you some chance of figuring out what is going on".</p>
<h2><a name="p-7000-note-module-lookup-is-already-sort-of-optimized-2" class="anchor" href="2.html#p-7000-note-module-lookup-is-already-sort-of-optimized-2"></a>Note: Module Lookup Is Already (Sort Of) Optimized</h2>
<p>The way module lookup works is that words hold a symbol, and that symbol points to a linked list of variable stubs--one for each module that defines that variable.</p>
<p>This wouldn't scale well for objects (think 10000 objects which all had a field "X", searching that list would be slow).  But for modules it's fairly fast, as few modules define the same symbol.  Also, once a word becomes bound it points directly to the stub for the variable.</p>
<p>(Just mentioning in case you were wondering why I'm fretting over lookup in frames and objects but not the cost of lookup in modules.)</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>

                <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
                      <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                        <a itemprop='url' href="../../optimizing-environment-lookup/2134.html">Optimizing Environment Lookup</a>
                        <meta itemprop='position' content='1'>
                      </div>
                      <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                        <a itemprop='url' href="../../rebol-and-scopes-well-why-not/1751/11.html">Rebol And Scopes: Well, Why Not?</a>
                        <meta itemprop='position' content='2'>
                      </div>
                </div>
          </div>
    </div>

      <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
          <span itemprop='name'>
            <a itemprop="url" href="../2119.html#post_2">show post in topic</a>
          </span>
      </div>

    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/guidelines' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    
  </body>
  
</html>
