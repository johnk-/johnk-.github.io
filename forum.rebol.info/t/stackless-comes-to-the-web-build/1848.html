<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Stackless Comes to the Web 🕸 Build - WebAssembly - AltRebol</title>
    <meta name="description" content="I made a beeline for us being able to use stackless in the web build, because that&amp;#39;s a place where it can get us some benefits.  Much work has brought it there, and the ReplPad served up as of today is stackless!  No Asy&amp;hellip;">
    <meta name="generator" content="Discourse 2.7.0.beta4 - https://github.com/discourse/discourse version 3fc72543de22c329cf2156f28b781821adc496ae">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="1848.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.rebol.info","potentialAction":{"@type":"SearchAction","target":"https://forum.rebol.info/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="AltRebol Search">

      <link href="https://forum.rebol.info/stylesheets/desktop_cdfbc200d3f5311dbee0f69ae668cfc42cfc8cb7.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="https://forum.rebol.info/stylesheets/desktop_theme_2_7b2b5b1bc734c2cc3b6ad5e0f49f467e8601ef2c.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Stackless Comes to the Web :spider_web: Build&#39;" href="1848.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/stackless-comes-to-the-web-build/1848" />
<meta name="twitter:url" content="https://forum.rebol.info/t/stackless-comes-to-the-web-build/1848" />
<meta property="og:title" content="Stackless Comes to the Web 🕸 Build" />
<meta name="twitter:title" content="Stackless Comes to the Web 🕸 Build" />
<meta property="og:description" content="I made a beeline for us being able to use stackless in the web build, because that&#39;s a place where it can get us some benefits.  Much work has brought it there, and the ReplPad served up as of today is stackless!  No Asyncify at all!    We get size benefits - Without the extra code generation added by Asyncify the %libr3.wasm file was down from ~1.8 megabytes to ~1.1 (I&#39;d said I recalled it made things about twice the size, and that&#39;s in the ballpark)    There hasn&#39;t been any extreme push to opt..." />
<meta name="twitter:description" content="I made a beeline for us being able to use stackless in the web build, because that&#39;s a place where it can get us some benefits.  Much work has brought it there, and the ReplPad served up as of today is stackless!  No Asyncify at all!    We get size benefits - Without the extra code generation added by Asyncify the %libr3.wasm file was down from ~1.8 megabytes to ~1.1 (I&#39;d said I recalled it made things about twice the size, and that&#39;s in the ballpark)    There hasn&#39;t been any extreme push to opt..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="6 ❤" />
<meta property="article:published_time" content="2022-06-25T23:04:33+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="https://forum.rebol.info/">
          <img src="../../uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" alt="AltRebol" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="1848.html">Stackless Comes to the Web 🕸 Build</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/8" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/emscripten/5" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>WebAssembly</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1848.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2022-06-25T23:04:33Z'>
              <time itemprop='dateModified' datetime='2022-06-26T06:11:33Z' class='post-time'>
                June 26, 2022,  6:11am
              </time>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I made a beeline for us being able to use stackless in the web build, because that's a place where it can get us some benefits.  Much work has brought it there, and <strong>the ReplPad served up as of today is stackless!</strong>  No <strong><a href="https://emscripten.org/docs/porting/asyncify.html">Asyncify</a></strong> at all!</p>
<ul>
<li>
<p><strong>We get size benefits</strong> - Without the extra code generation added by Asyncify the <code>%libr3.wasm</code> file was down from ~1.8 megabytes to ~1.1 <em>(I'd said I recalled it made things about twice the size, and that's in the ballpark)</em></p>
<ul>
<li>
<p>There hasn't been any extreme push to optimize Ren-C on size, but I think it will be appealing when someone could have access to the functionality of the interpreter on their website for under a megabyte... when things like Golden Layout are a megabyte just for tabbed windows, a whole interpreter and PARSE doesn't seem a bad deal!</p>
</li>
<li>
<p>I want to push ever more of the features into little "WebAssembly DLLs" that you can pick from a-la-carte, and only pay for what you use.  How minimal a core we can get is a question to pursue.  But right now there's lots of stuffing (two PARSE implementations, for example) that hopefully the future can rein in.</p>
</li>
</ul>
</li>
<li>
<p><strong>We get speed benefits</strong> - Asyncify didn't just add bytes to the compiled code, those were bytes that were instructions that did stuff.  It added bookkeeping to know how to unwind stacks of generic code it didn't know anything about.</p>
<pre><code>ren-c-asyncify&gt;&gt; x: [] delta-time [repeat 10000 [append x [a b]]]
== 0:00:00.070

ren-c-stackless&gt;&gt; x: [] delta-time [repeat 10000 [append x [a b]]]
== 0:00:00.028
</code></pre>
<p>That comparison isn't 100% fair, because that asyncify version is post-stackless code, hence it was instrumenting the stackless trampoline.  <em>But I'd imagine that it's easily twice as fast, as well as being half the size!</em></p>
</li>
</ul>
<p><strong>In just this evening after the change, I've already done some performance work that makes the Web REPL feel significantly snappier...try it out!</strong></p>
<h2>But Most Importantly, We Get More Working Features!</h2>
<p>Asyncify's big achilles heel is that when it suspends your codebase, it's suspended.  It can't do anything until it is fully resumed.*</p>
<p><sub>* You can actually put a few functions on a blacklist of things that can be called despite the stack being suspended.  But it's probably the case that the most important parts of your program need the asyncify treatment: in Ren-C's case, that was the evaluator.  There's things you can do without the evaluator <em>(scan code into array structures, for instance?)</em></sub></p>
<p>Stackless makes us masters of time and space as far as the stack is concerned.  <a class="mention" href="https://forum.rebol.info/u/gchiu">@gchiu</a> was trying to do something seemingly trivial, like attach some JavaScript to a button that would call:</p>
<pre><code> reb.Elide("write clipboard:// {hello}")
</code></pre>
<p>With all that's been accomplished so far you'd think that would have been relatively easy.  But the moment when you call it matters a lot. The Repl was rigged very carefully to work with Asyncify and be able to run code when it was "its turn"--e.g. when it wasn't sleeping, having passed the baton to the GUI to gather user input.</p>
<p>With stackless these things become unblocked, and a lot of the tricky manipulations that weren't under our control are coming under it.  Things should hopefully get better (!)</p>
<h2>Question: Can We Hang Onto Some of the Asyncify Knowledge?</h2>
<p>Having been through the labor of making code that wasn't stackless interoperate in the browser, I can't help but wonder if there's some way that we can keep the functionality in our pocket in case some situation could be helped by it.</p>
<div class="onebox lazyYT lazyYT-container" data-youtube-id="qQOP6jqZqf8" data-youtube-title="Pause and Resume WebAssembly with Asyncify, Alon Zakai" data-parameters="feature=oembed&amp;wmode=opaque">
  <a href="https://www.youtube.com/watch?v=qQOP6jqZqf8" target="_blank" rel="noopener">
    <img class="ytp-thumbnail-image" src="https://i.ytimg.com/vi/qQOP6jqZqf8/maxresdefault.jpg" title="Pause and Resume WebAssembly with Asyncify, Alon Zakai" width="690" height="388">
  </a>
</div>

<p>I don't completely understand the <a href="https://github.com/WebAssembly/binaryen/blob/5811c2c7d50c10327565a23e19bf39c105593710/src/passes/Asyncify.cpp#L130">custom unwinding concepts</a>, but Alon makes it <em>sound</em> like we might be able to take any non-stackless natives and specifically instrument them.  Like if when the Trampoline went to unwind it hit a stackful wall (a "root frame", as I call them) we might be able to selectively bundle the call stack between that wall and the next stackless point.</p>
<p>I'm not sure if it's worth weeks of effort to figure out if we can do it, but it's probably worth a bit.  There are codebases of WebAssembly stuff for doing graphics and music and things like that...and we might want to hook them in a way that they call into us, even if they rely on Asyncify to do their work.</p>
<p>We've talked about having more "technology demos" just to show the versatility (e.g. <a href="https://wasmedge.org/">integrating with WasmEdge</a>) and so I feel like the more the merrier on that.</p>
<p><em>(It's hard to prioritize when there's so many cool directions to take things!  But I continue to go after fundamentals, and try to stay the course on that...)</em></p>
        </div>

        <meta itemprop='headline' content='Stackless Comes to the Web :spider_web: Build'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/BlackATTR'><span itemprop='name'>BlackATTR</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1848.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2022-06-26T02:16:00Z' class='post-time'>
                June 26, 2022,  2:16am
              </time>
              <meta itemprop='dateModified' content='2022-06-26T02:16:00Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Mind-blowing, fantastic work Brian! Your work has put things in a place where they're poised to break-out!</p>
        </div>

        <meta itemprop='headline' content='Stackless Comes to the Web :spider_web: Build'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1848.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2022-06-28T03:51:09Z' class='post-time'>
                June 28, 2022,  3:51am
              </time>
              <meta itemprop='dateModified' content='2022-06-28T03:51:09Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-username="hostilefork" data-post="1" data-topic="1848">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="https://forum.rebol.info/user_avatar/forum.rebol.info/hostilefork/40/26_2.png" class="avatar"> hostilefork:</div>
<blockquote>
<p>Without the extra code generation added by Asyncify the <code>%libr3.wasm</code> file was down from ~1.8 megabytes to ~1.1</p>
</blockquote>
</aside>
<p><em>Some build settings adjusted and libr3.wasm is now down to just 681k</em>.</p>
<p>But that's nowhere near the bottom of where we can go with this, I'm certain of it!</p>
        </div>

        <meta itemprop='headline' content='Stackless Comes to the Web :spider_web: Build'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/guidelines' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  
</html>
