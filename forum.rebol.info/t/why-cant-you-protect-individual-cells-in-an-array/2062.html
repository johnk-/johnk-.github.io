<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Why can&#39;t you PROTECT individual cells in an array? - Debugger - AltRebol</title>
    <meta name="description" content="You can PROTECT a variable: 
&amp;gt;&amp;gt; x: 10

&amp;gt;&amp;gt; protect &amp;#39;x

&amp;gt;&amp;gt; x: 20
** Access Error: variable x locked by PROTECT (see UNPROTECT)

And you can PROTECT an array pointed to by a variable: 
&amp;gt;&amp;gt; array: [&amp;lt;a&amp;gt; b #c]

&amp;gt;&amp;gt; protect array&amp;hellip;">
    <meta name="generator" content="Discourse 3.1.0.beta4 - https://github.com/discourse/discourse version 25276f62f959eab4557049a655300a70835c5769">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" media="all" content="#ffffff">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="2062.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="AltRebol Search">

    <link href="https://forum.rebol.info/stylesheets/color_definitions_base__2_caa66e77e807fc270e5b21d201643962219b6a9a.css?__ws=forum.rebol.info" media="all" rel="stylesheet" class="light-scheme"/>

  <link href="https://forum.rebol.info/stylesheets/desktop_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop"  />



  <link href="https://forum.rebol.info/stylesheets/chat_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="chat"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-details_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-details"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-lazy-videos_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-local-dates_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-narrative-bot_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
  <link href="https://forum.rebol.info/stylesheets/discourse-presence_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="discourse-presence"  />
  <link href="https://forum.rebol.info/stylesheets/docker_manager_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="docker_manager"  />
  <link href="https://forum.rebol.info/stylesheets/poll_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="poll"  />
  <link href="https://forum.rebol.info/stylesheets/chat_desktop_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="chat_desktop"  />
  <link href="https://forum.rebol.info/stylesheets/poll_desktop_97f5da14b02e14a864d77b6d983a33a1b302f894.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="poll_desktop"  />

  <link href="https://forum.rebol.info/stylesheets/desktop_theme_2_5e18a6fac02b6ab11e33445179f4a2961aadbfd8.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2" data-theme-name="default"/>

    
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Why can&#39;t you PROTECT individual cells in an array?&#39;" href="2062.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/why-cant-you-protect-individual-cells-in-an-array/2062" />
<meta name="twitter:url" content="https://forum.rebol.info/t/why-cant-you-protect-individual-cells-in-an-array/2062" />
<meta property="og:title" content="Why can&#39;t you PROTECT individual cells in an array?" />
<meta name="twitter:title" content="Why can&#39;t you PROTECT individual cells in an array?" />
<meta property="og:description" content="You can PROTECT a variable:  &gt;&gt; x: 10  &gt;&gt; protect &#39;x  &gt;&gt; x: 20 ** Access Error: variable x locked by PROTECT (see UNPROTECT)  And you can PROTECT an array pointed to by a variable:  &gt;&gt; array: [&lt;a&gt; b #c]  &gt;&gt; protect array  &gt;&gt; append array [&quot;d&quot;] ** Access Error: series read-only due to PROTECT (see UNPROTECT)  &gt;&gt; array: [&lt;q&gt; r #s]  ; variable holding array not protected  &gt;&gt; array == [&lt;q&gt; r #s]  ...but you can&#39;t PROTECT a cell resident inside an array:  &gt;&gt; array: [&lt;a&gt; b #c]  &gt;&gt; protect &#39;array.2  ; ..." />
<meta name="twitter:description" content="You can PROTECT a variable:  &gt;&gt; x: 10  &gt;&gt; protect &#39;x  &gt;&gt; x: 20 ** Access Error: variable x locked by PROTECT (see UNPROTECT)  And you can PROTECT an array pointed to by a variable:  &gt;&gt; array: [&lt;a&gt; b #c]  &gt;&gt; protect array  &gt;&gt; append array [&quot;d&quot;] ** Access Error: series read-only due to PROTECT (see UNPROTECT)  &gt;&gt; array: [&lt;q&gt; r #s]  ; variable holding array not protected  &gt;&gt; array == [&lt;q&gt; r #s]  ...but you can&#39;t PROTECT a cell resident inside an array:  &gt;&gt; array: [&lt;a&gt; b #c]  &gt;&gt; protect &#39;array.2  ; ..." />
<meta property="og:article:section" content="Development" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="og:article:section" content="Debugger" />
<meta property="og:article:section:color" content="25AAE2" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="1 ❤" />
<meta property="article:published_time" content="2023-11-21T22:52:50+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    
    <header>
  <a href="https://forum.rebol.info/">
    AltRebol
  </a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="2062.html">Why can&#39;t you PROTECT individual cells in an array?</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/8" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/debugger/34" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Debugger</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  

    <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Why can&#39;t you PROTECT individual cells in an array?'>
        <meta itemprop='articleSection' content='Debugger'>
      <meta itemprop='keywords' content=''>
      <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
        <meta itemprop='name' content='AltRebol'>
          <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
            <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
          </div>
      </div>

          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
                
              </span>

              <link itemprop="mainEntityOfPage" href="2062.html">


              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2023-11-21T22:52:50Z' class='post-time'>
                    November 21, 2023, 10:52pm
                  </time>
                  <meta itemprop='dateModified' content='2023-11-21T23:03:03Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='articleBody'>
              <p>You can PROTECT a variable:</p>
<pre><code>&gt;&gt; x: 10

&gt;&gt; protect 'x

&gt;&gt; x: 20
** Access Error: variable x locked by PROTECT (see UNPROTECT)
</code></pre>
<p>And you can PROTECT an array pointed to by a variable:</p>
<pre><code>&gt;&gt; array: [&lt;a&gt; b #c]

&gt;&gt; protect array

&gt;&gt; append array ["d"]
** Access Error: series read-only due to PROTECT (see UNPROTECT)

&gt;&gt; array: [&lt;q&gt; r #s]  ; variable holding array not protected

&gt;&gt; array
== [&lt;q&gt; r #s]
</code></pre>
<p>...but you can't PROTECT a cell resident inside an array:</p>
<pre><code>&gt;&gt; array: [&lt;a&gt; b #c]

&gt;&gt; protect 'array.2  ; this doesn't work

&gt;&gt; array.2: "z"
; you'd expect an error here if it did work

&gt;&gt; array.3: 1020
; you'd expect no error here if it did work
</code></pre>
<p>R3-Alpha didn't have the feature, and Ren-C hasn't added it.  Why?</p>
<h2>
<a name="making-this-work-would-add-significant-complexity-1" class="anchor" href="2062.html#making-this-work-would-add-significant-complexity-1"></a>Making This Work Would Add Significant Complexity</h2>
<p>Your first thought (well, mine) would be that this is about efficiency.  e.g. if you were going to write something like <strong>clear block</strong>, the existence of PROTECT'd cells inside that block would mean you'd have to visit all the cells before knowing if it was okay to clear it.  Other code that already has to visit the cells in order to copy them would still pay a little more too... like <strong>take/part</strong>.</p>
<p><em>But that's not where the real problem is.</em>  Paying a little more for mutating operations is only slightly relevant.  The real problem has to do with a pointer to a cell not being able to answer the question of its own mutability--since it can't speak for the container's protection status.</p>
<p>In more detail:</p>
<p>Ren-C's clever management of immutability uses the C <code>const</code> designator.  What the const means on a <em>series</em> is that the series may be mutable, but hasn't had a runtime check yet to flip it over to being readable.  And what the const means on <em>cells</em> is that the cell was <em>extracted</em> from a series that may be mutable, but hadn't had the runtime check applied.</p>
<p>This way, casual code that just messes around reading cells and series can be written easily, using const pointers and not paying for runtime checks.  And you can be certain of not skipping the runtime checks in the places where you want to get mutable access.  (R3-Alpha was full of bugs from "just forgetting".)</p>
<p>The problem with getting a granularity of cell-level mutability is that right now, there's just one runtime check that gives you a mutable cell pointer...done at the array level:</p>
<pre><code>Cell* tail;
Cell* cell = VAL_ARRAY_AT_ENSURE_MUTABLE(&amp;tail, block);
</code></pre>
<p>There are multiple checks done, here.  The BLOCK! cell passed in may or may not carry a CONST cell bit--which is to say, that particular reference to the BLOCK! might be const (even if the underlying array hasn't been PROTECT'd).  And then, there's the protection status of the array...which can also become protected during enumerations of the array, or if it is executing currently in the evaluator.</p>
<p>If this code doesn't trigger a failure from discovering a form of mutability, then the non-const <code>Cell*</code> is given back.</p>
<p>But then...the code will increment that cell pointer to find other cells in the array.  And incrementing a mutable pointer gives you another mutable pointer.</p>
<p>It may seem we <em>could</em> make <code>Cell(*)</code> in the C++ debug build a smart pointer class that gives you back a <code>Cell(const*)</code> when incremented.  And then say that there's a way to promote a const cell reference to a mutable cell reference with a runtime check.</p>
<p>But this would be deceptive.  We already know that if you have a const reference to a cell that lives in the middle of an array, that a runtime check of the containing array for that cell hasn't been done yet.</p>
<p>In other words: once you have your hands on a cell pointer, it's too late to ask about <em>that</em> cell's mutability.  The knowledge is up to the container.</p>
<p>Trying to solve this would be a mess.  e.g. making a kind of Cell(const*) that was the size of two pointers, but held a reference to the array the cell was resident in...in case you wanted to do the runtime check asking for a promotion to a Cell(*).</p>
<p>I've been moving in the other direction...paring away complexities in the source where possible.  Something like that doesn't belong in the codebase--especially to implement a feature that I can only vaguely imagine uses for.</p>
<h2>
<a name="so-dont-expect-cell-level-protectever-2" class="anchor" href="2062.html#so-dont-expect-cell-level-protectever-2"></a>So Don't Expect Cell-Level PROTECT...Ever</h2>
<p>Every now and again I've looked at the flag and thought "why does this apply only to variable cells?"  So I wanted to hammer out the reasoning, and confirm that it wasn't just about performance.</p>
<p>From my point of view, it's about creating a situation of a flag that needs to be checked, and which the code has no (reasonable) systemic way to enforce that checking.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
                <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
                <meta itemprop="userInteractionCount" content="0" />
              </div>

          </div>
    </div>






    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/guidelines' itemprop="url">FAQ/Guidelines </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
        </span>
      </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    
  </body>
  
</html>
