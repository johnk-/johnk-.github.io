<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Advancements in CastHelper for Hooked Casts - C/C++ Implementation - AltRebol</title>
    <meta name="description" content="Progress has been fairly amazing on the debug checks for casts. 
The &amp;quot;user experience&amp;quot; of writing hooks for the casts used to be very hard-to-read code for a non-C++ programmer...but it&amp;#39;s now very simple! 
Just to give o&amp;hellip;">
    <meta name="generator" content="Discourse 3.5.0.beta6-dev - https://github.com/discourse/discourse version 623cde985b21c2ed812b83d3ea94f69231613718">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" media="all" content="#fff">

<meta name="color-scheme" content="light">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="2488.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="AltRebol Search">

    <link href="https://rebol.metaeducation.com/stylesheets/color_definitions_base__2_ceb61c279a74dfa3cef6a62f7784988102abec82.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" class="light-scheme"/>

<link href="https://rebol.metaeducation.com/stylesheets/common_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="common"  />

  <link href="https://rebol.metaeducation.com/stylesheets/desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="desktop"  />



    <link href="https://rebol.metaeducation.com/stylesheets/chat_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="chat"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-details_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-lazy-videos_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-local-dates_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-narrative-bot_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-presence_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="https://rebol.metaeducation.com/stylesheets/docker_manager_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="https://rebol.metaeducation.com/stylesheets/footnote_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="https://rebol.metaeducation.com/stylesheets/poll_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="poll"  />
    <link href="https://rebol.metaeducation.com/stylesheets/spoiler-alert_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="https://rebol.metaeducation.com/stylesheets/chat_desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="chat_desktop"  />
    <link href="https://rebol.metaeducation.com/stylesheets/poll_desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="poll_desktop"  />

  <link href="https://rebol.metaeducation.com/stylesheets/common_theme_2_57fe803ed5a41e9f7d94086afaf66a1aab57d9ae.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="2" data-theme-name="default"/>
    

    
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Advancements in CastHelper for Hooked Casts&#39;" href="2488.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://rebol.metaeducation.com/t/advancements-in-casthelper-for-hooked-casts/2488" />
<meta name="twitter:url" content="https://rebol.metaeducation.com/t/advancements-in-casthelper-for-hooked-casts/2488" />
<meta property="og:title" content="Advancements in CastHelper for Hooked Casts" />
<meta name="twitter:title" content="Advancements in CastHelper for Hooked Casts" />
<meta property="og:description" content="Progress has been fairly amazing on the debug checks for casts.  The &quot;user experience&quot; of writing hooks for the casts used to be very hard-to-read code for a non-C++ programmer...but it&#39;s now very simple!  Just to give one example, consider casting to an &quot;Element&quot; (e.g. an Array element, something that can live in a BLOCK! or GROUP!).  As a reminder of what the idea is: anywhere in the source where you write either:  cast(Element*, ...) cast(const Element*, ...)  In an ordinary C build, it will ..." />
<meta name="twitter:description" content="Progress has been fairly amazing on the debug checks for casts.  The &quot;user experience&quot; of writing hooks for the casts used to be very hard-to-read code for a non-C++ programmer...but it&#39;s now very simple!  Just to give one example, consider casting to an &quot;Element&quot; (e.g. an Array element, something that can live in a BLOCK! or GROUP!).  As a reminder of what the idea is: anywhere in the source where you write either:  cast(Element*, ...) cast(const Element*, ...)  In an ordinary C build, it will ..." />
<meta property="og:article:section" content="Development" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="og:article:section" content="C/C++ Implementation" />
<meta property="og:article:section:color" content="25AAE2" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="2 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="2 â¤" />
<meta property="article:published_time" content="2025-06-15T20:21:16+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    
    <header>
  <a href="https://rebol.metaeducation.com/">AltRebol</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="2488.html">Advancements in CastHelper for Hooked Casts</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://rebol.metaeducation.com/c/development/c-cpp-implementation/62" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://rebol.metaeducation.com/c/development/c-cpp-implementation/62" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>C/C++ Implementation</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  

    <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Advancements in CastHelper for Hooked Casts'>
      <link itemprop='url' href='2488.html'>
      <meta itemprop='datePublished' content='2025-06-15T20:21:16Z'>
        <meta itemprop='articleSection' content='C/C++ Implementation'>
      <meta itemprop='keywords' content=''>
      <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
        <meta itemprop='name' content='AltRebol'>
          <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
            <meta itemprop='url' content='https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='https://rebol.metaeducation.com/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="2488.html">


              <span class="crawler-post-infos">
                  <time  datetime='2025-06-15T20:21:16Z' class='post-time'>
                    June 15, 2025,  8:21pm
                  </time>
                  <meta itemprop='dateModified' content='2025-07-09T03:42:43Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Progress has been fairly amazing on the debug checks for casts.</p>
<p>The "user experience" of writing hooks for the casts used to be very hard-to-read code for a non-C++ programmer...but it's now very simple!</p>
<p>Just to give one example, consider casting to an "Element" (e.g. an Array element, something that can live in a BLOCK! or GROUP!).</p>
<p>As a reminder of what the idea is: anywhere in the source where you write either:</p>
<pre><code>cast(Element*, ...)
cast(const Element*, ...)
</code></pre>
<p>In an ordinary C build, it will just act like:</p>
<pre><code>(Element*)(...)
(const Element*)(...)
</code></pre>
<p>But in an instrumented build using C++, it's possible to add checks.  These checks can be at compile-time (prohibiting conversions of some combination of types)... or they can be at runtime, validating the bit patterns of the thing being converted.</p>
<p>For Element, we have:</p>
<pre><code>DECLARE_C_TYPE_LIST(g_convertible_to_cell,
    Cell, Atom, Element, Value,
    Pairing,
    Node, Byte, char, void
);

template&lt;typename F&gt;
struct CastHelper&lt;const F*, const Element*&gt; {
  static void Validate_Bits(const F* p)
  {
    STATIC_ASSERT(In_C_Type_List(g_convertible_to_cell, F));

    const Cell* c = u_cast(const Cell*, p);
    Assert_Cell_Readable(c);
    assert(LIFT_BYTE(c) != ANTIFORM_0);
  }
};
</code></pre>
<p><strong>That's extremely easy to read!</strong></p>
<ul>
<li>
<p>We are making sure that the <a href="../how-quoting-levels-are-implemented-isotope-normal-quasi-quoted/2091.html">LIFT_BYTE() is not 0</a>, hence not an antiform.</p>
</li>
<li>
<p>We're also checking that it's a valid readable cell (e.g. the bits have NODE_FLAG_NODE and NODE_FLAG_CELL, and NODE_FLAG_UNREADABLE is not set.)**</p>
</li>
<li>
<p>Plus, at <strong>compile-time</strong>, it's stopping you from all manner of casts which might be accidental to make Cells from things that can't make sense as Cells.</p>
</li>
</ul>
<p>What <strong><code>template&lt;typename F&gt;</code></strong>  means is that this is a "wildcard" pattern-matching rule, that the compiler will try to match against any pointer to F.  The name F is arbitrary, but chosen to represent "FROM", e.g. the datatype we are converting from.</p>
<p>(It would be possible to use more than one wildcard, e.g. <strong><code>template&lt;typename F, typename T&gt;</code></strong> and match patterns in both the "TO" and the "FROM".  But here we're fixed as defining conversions TO an Element*, so there's no second parameter to the template.)</p>
<h2><a name="p-8428-write-just-the-const-casts-works-for-mutable-1" class="anchor" href="2488.html#p-8428-write-just-the-const-casts-works-for-mutable-1"></a>Write Just The Const Casts, Works For Mutable</h2>
<p>I hammered on this until I could get it to where you could just write the const casts, and it will take care of the mutable form casts (including blocking casting away constness)... running through the same code.  So you don't have to write two entry points and do the piping through common code yourself.</p>
<p>I'm on the fence on whether it's worth it to put in wiring to make it possible to separately hook mutable casts--to make sure the bit patterns you have are legal for a mutable pointer.  That's not really needed given the protection of casting away constness, and the cases where you do cast mutably from raw pointers you probably are doing that on purpose.  But definitely it needs to default to that if you write just the const casts you hook all of them for that pattern match, because this is 99% of the time what you want...it shouldn't be laborious.</p>
<h2><a name="p-8428-c-is-minimized-declare_c_type_list-2" class="anchor" href="2488.html#p-8428-c-is-minimized-declare_c_type_list-2"></a>C++ Is Minimized: DECLARE_C_TYPE_LIST()</h2>
<p>Without DECLARE_C_TYPE_LIST() and In_C_Type_List(), this would look like:</p>
<pre><code>using g_convertible_to_cell = CTypeList&lt;
    Cell, Atom, Element, Value,
    Pairing,
    Node, Byte, char, void
)&gt;;

STATIC_ASSERT((g_convertible_to_cell::contains&lt;F&gt;{}));
</code></pre>
<p>It's quirky--including the quirk that you can't call the STATIC_ASSERT() macro on expressions which contain templating <code>&lt;...&gt;</code> markers unless they're wrapped in an extra set of parentheses.  So you have to use <code>static_assert()</code> which enforces arity-2 in C++11.</p>
<h2><a name="p-8428-also-less-c-u_cast-3" class="anchor" href="2488.html#p-8428-also-less-c-u_cast-3"></a>Also Less C++: u_cast()</h2>
<p>You don't want to run the cast hooks while implementing a cast hook!  Originally I used <code>reinterpret_cast</code> in this code, so it looked like:</p>
<pre data-code-wrap="plaintext"><code class="lang-plaintext">    const Cell* c = reinterpret_cast&lt;const Cell*&gt;(p);
    Assert_Cell_Readable(c);
    assert(LIFT_BYTE(c) != ANTIFORM_0);
    return reinterpret_cast&lt;const Element*&gt;(c);
</code></pre>
<p>But the casting system offers <strong><code>u_cast()</code></strong> as an "unchecked" cast that nevers run the hooks (but is easier to spot as being a cast than the parentheses cast it expands to).</p>
<p>It makes it shorter and less scary to use <code>u_cast()</code>, and that's what's used in the rest of the codebase to implement unchecked cast.  So that helps make the code more familiar to what the rest of the C looks like.</p>
<h2><a name="p-8428-should-the-template-be-abstracted-away-too-4" class="anchor" href="2488.html#p-8428-should-the-template-be-abstracted-away-too-4"></a>Should The <code>template&lt;&gt;</code> be Abstracted Away, Too?</h2>
<p>I don't think so.</p>
<p>I think that goes into the realm of pandering a bit too much to C fraidy-cats.  It's tougher to abstract and I think that token-for-token, it gets it right.</p>
<p>The value here is apparent--and I think I've done as much pandering as is appropriate.  What's left is legitimate C++ that matches the essential complexity of the problem.  (It's not even duplicating the signature of the types needlessly, as you might use reference types in those positions.)</p>
<h2><a name="p-8428-in-total-this-is-awesome-stuff-5" class="anchor" href="2488.html#p-8428-in-total-this-is-awesome-stuff-5"></a>In Total, This Is Awesome Stuff</h2>
<p>It's not just about the common casts.  This gives you surgical precision if you're facing a particular debugging problem that's narrowed down, and you want to write a bit of custom instrumentation just to catch the problem you're working on.</p>
<p>Ren-C is able to stay robust despite being a very "Amish" codebase, due to having many of these kinds of features to keep the trains running on time.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>

          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='https://rebol.metaeducation.com/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
                
              </span>


                <link itemprop="image" href="../../uploads/default/original/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e.jpeg">

              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2025-06-16T00:21:20Z' class='post-time'>
                    June 16, 2025, 12:21am
                  </time>
                  <meta itemprop='dateModified' content='2025-06-16T02:53:45Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <aside class="quote no-group" data-username="hostilefork" data-post="1" data-topic="2488">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="24" height="24" src="../../user_avatar/rebol.metaeducation.com/hostilefork/48/421_2.png" class="avatar"> hostilefork:</div>
<blockquote>
<p>Ren-C is able to stay robust despite being a very "Amish" codebase, due to having many of these kinds of features to keep the trains running on time.</p>
</blockquote>
</aside>
<p>I'll mention that I'm factoring this stuff out (along with the <a href="../antiform-safety-covariance-and-contravariance/2330.html">contravariance mechanics</a>, and other things) as a library which other C projects could use.</p>
<p>But also... so it can have its own set of regression tests.  Because currently the only "test" is having it build the Ren-C codebase.  So if I tweak it and something stops working (e.g. it doesn't run a cast hook that it should) I have no real way of finding out about that, besides setting breakpoints in the hooks and seeing if they're hit or not.</p>
<h2><a name="p-8429-library-name-needful-1" class="anchor" href="2488.html#p-8429-library-name-needful-1"></a>Library Name: "Needful"</h2>
<p><a href="https://github.com/hostilefork/ren-c/blob/5849886281c25a6695af8b92823d8766338b014f/src/include/needful/needful-sinks.h">Because it has wrappers like Sink(T), Need(T), Init(T)</a>... ChatGPT had a funny suggestion of calling the library "Needful", as in the amusing Indian-English phrase <em><strong><a href="https://www.grammarly.com/blog/idioms/do-the-needful/">"do the needful"</a></strong></em>.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e.jpeg" data-download-href="https://rebol.metaeducation.com/uploads/default/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e" title="image"><img src="../../uploads/default/optimized/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e_2_345x230.jpeg" alt="image" data-base62-sha1="uXpTkL7kfiFGxZeubB8lOQ1t3Qy" width="345" height="230" srcset="../../uploads/default/optimized/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e_2_345x230.jpeg, ../../uploads/default/optimized/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e_2_517x345.jpeg 1.5x, ../../uploads/default/optimized/1X/d8f8a9d4ac37fa0bdbfa61c7f0f43d0f9415bd6e_2_690x460.jpeg 2x" data-dominant-color="5D5D40"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1536Ã—1024 276 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>I legitimately think this could be helpful for many codebases that have to build as C, for embedded purposes/etc.  Using a C++ compiler to do static analysis is a tool you almost certainly have around, and there's nothing special to set up or install or configure.</p>
<p>It needs a good marketing phraseology...</p>
<p><em><strong>"Needful: The library that does nothing in your C programs (and you NEED it!)"</strong></em></p>
<p><img src="../../images/emoji/twitter/slight_smile.png%3Fv=14" title=":slight_smile:" class="emoji only-emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>

          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/categories' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/guidelines' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://rebol.metaeducation.com/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://rebol.metaeducation.com/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    
  </body>
  
</html>
