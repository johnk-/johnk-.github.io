<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pure and Refined: Simplifying Refinements to One or Zero Args - #9 by hostilefork - Internals - AltRebol</title>
    <meta name="description" content="I&amp;#39;m always frustrated trying to name refinement arguments: 
rebol2&amp;gt;&amp;gt; negate-maybe-add: func [value [integer!] /add add-arg [integer!]] [
             if add [return (negate value) + add-arg]
             return negate va&amp;hellip;">
    <meta name="generator" content="Discourse 3.5.0.beta6-dev - https://github.com/discourse/discourse version 623cde985b21c2ed812b83d3ea94f69231613718">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" media="all" content="#fff">

<meta name="color-scheme" content="light">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="../1120.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="AltRebol Search">

    <link href="https://rebol.metaeducation.com/stylesheets/color_definitions_base__2_ceb61c279a74dfa3cef6a62f7784988102abec82.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" class="light-scheme"/>

<link href="https://rebol.metaeducation.com/stylesheets/common_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="common"  />

  <link href="https://rebol.metaeducation.com/stylesheets/desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="desktop"  />



    <link href="https://rebol.metaeducation.com/stylesheets/chat_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="chat"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-details_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-lazy-videos_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-local-dates_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-narrative-bot_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="https://rebol.metaeducation.com/stylesheets/discourse-presence_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="https://rebol.metaeducation.com/stylesheets/docker_manager_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="https://rebol.metaeducation.com/stylesheets/footnote_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="https://rebol.metaeducation.com/stylesheets/poll_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="poll"  />
    <link href="https://rebol.metaeducation.com/stylesheets/spoiler-alert_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="https://rebol.metaeducation.com/stylesheets/chat_desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="chat_desktop"  />
    <link href="https://rebol.metaeducation.com/stylesheets/poll_desktop_e0a75505da9bc96953dd62a4aad773a25cca0f8e.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="poll_desktop"  />

  <link href="https://rebol.metaeducation.com/stylesheets/common_theme_2_57fe803ed5a41e9f7d94086afaf66a1aab57d9ae.css?__ws=rebol.metaeducation.com" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="2" data-theme-name="default"/>
    

    
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Pure and Refined: Simplifying Refinements to One or Zero Args&#39;" href="../1120.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://rebol.metaeducation.com/t/pure-and-refined-simplifying-refinements-to-one-or-zero-args/1120/9" />
<meta name="twitter:url" content="https://rebol.metaeducation.com/t/pure-and-refined-simplifying-refinements-to-one-or-zero-args/1120/9" />
<meta property="og:title" content="Pure and Refined: Simplifying Refinements to One or Zero Args" />
<meta name="twitter:title" content="Pure and Refined: Simplifying Refinements to One or Zero Args" />
<meta property="og:description" content="I&#39;m doing a bit of maintenance on the bootstrap executable, and I&#39;m quite dizzy looking at the hoops SPECIALIZE tried to jump through to work with the original model.  We still face some questions about how to do reordering of parameters.  But this stuff was crazy.  Here&#39;s some comments about the convoluted logic:  // A specialization is an ACTION! which has some of its parameters fixed. // e.g. `ap10: specialize &#39;append [value: 5 + 5]` makes ap10 have all the same // refinements available as A..." />
<meta name="twitter:description" content="I&#39;m doing a bit of maintenance on the bootstrap executable, and I&#39;m quite dizzy looking at the hoops SPECIALIZE tried to jump through to work with the original model.  We still face some questions about how to do reordering of parameters.  But this stuff was crazy.  Here&#39;s some comments about the convoluted logic:  // A specialization is an ACTION! which has some of its parameters fixed. // e.g. `ap10: specialize &#39;append [value: 5 + 5]` makes ap10 have all the same // refinements available as A..." />
<meta property="og:article:section" content="Development" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="og:article:section" content="Internals" />
<meta property="og:article:section:color" content="25AAE2" />
<meta property="og:article:tag" content="best-of" />
<meta property="article:published_time" content="2025-04-01T04:42:53+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    
    <header>
  <a href="https://rebol.metaeducation.com/">AltRebol</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="../1120.html">Pure and Refined: Simplifying Refinements to One or Zero Args</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://rebol.metaeducation.com/c/development/internals/9" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://rebol.metaeducation.com/c/development/internals/9" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Internals</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../../tag/best-of.html' class='discourse-tag' rel="tag">best-of</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Pure and Refined: Simplifying Refinements to One or Zero Args'>
      <link itemprop='url' href='../1120.html'>
      <meta itemprop='datePublished' content='2019-03-18T09:49:53Z'>
        <meta itemprop='articleSection' content='Internals'>
      <meta itemprop='keywords' content='best-of'>
      <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
        <meta itemprop='name' content='AltRebol'>
          <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
            <meta itemprop='url' content='https://rebol.metaeducation.com/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
          </div>
      </div>

          <span itemprop='author' itemscope itemtype="http://schema.org/Person">
            <meta itemprop='name' content='hostilefork'>
            <link itemprop='url' rel='nofollow' href='https://rebol.metaeducation.com/u/hostilefork'>
          </span>
        <meta itemprop='text' content='I&amp;#39;m always frustrated trying to name refinement arguments: 
rebol2&amp;gt;&amp;gt; negate-maybe-add: func [value [integer!] /add add-arg [integer!]] [
             if add [return (negate value) + add-arg]
             return negate va&amp;hellip;'>

          <div id='post_9' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='https://rebol.metaeducation.com/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2025-04-01T04:42:53Z' class='post-time'>
                    April 1, 2025,  4:42am
                  </time>
                  <meta itemprop='dateModified' content='2025-04-01T08:18:35Z'>
              <span itemprop='position'>9</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <aside class="quote no-group" data-username="hostilefork" data-post="3" data-topic="1120">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="24" height="24" src="../../../user_avatar/rebol.metaeducation.com/hostilefork/48/421_2.png" class="avatar"> hostilefork:</div>
<blockquote>
<p>Take my word for it from writing the evaluator and things like SPECIALIZE. If you want to talk about impacts on the system from a performance and memory standpoint, this is an <em>huge</em> benefit. The cost of the blocks you'll never make pale in comparison. Shortens function specs, saves space, simplifies broadly.</p>
</blockquote>
</aside>
<p>I'm doing a bit of maintenance on the bootstrap executable, and I'm quite dizzy looking at the hoops SPECIALIZE tried to jump through to work with the original model.</p>
<p>We still face some questions about how to do reordering of parameters.  But this stuff was crazy.</p>
<p>Here's some comments about the convoluted logic:</p>
<pre><code>// A specialization is an ACTION! which has some of its parameters fixed.
// e.g. `ap10: specialize 'append [value: 5 + 5]` makes ap10 have all the same
// refinements available as APPEND, but otherwise just takes one series arg,
// as it will always be appending 10.
//
// The method used is to store a FRAME! in the specialization's Action Body.
// It contains non-null values for any arguments that have been specialized.
// Eval_Core_Throws() heeds these when walking parameters (see `L-&gt;special`),
// and processes slots with nulls in them normally.
//
// Code is shared between the SPECIALIZE native and specialization of a
// GET-PATH! via refinements, such as `adp: :append/dup/part`.  However,
// specifying a refinement without all its arguments is made complicated
// because ordering matters:
//
//     foo: func [/ref1 arg1 /ref2 arg2 /ref3 arg3] [...]
//
//     foo23: :foo/ref2/ref3
//     foo32: :foo/ref3/ref2
//
//     foo23 A B ;-- should give A to arg2 and B to arg3
//     foo32 A B ;-- should give B to arg2 and A to arg3
//
// Merely filling in the slots for the refinements specified with TRUE will
// not provide enough information for a call to be able to tell the difference
// between the intents.  Also, a call to `foo23/ref1 A B C` does not want to
// make arg1 A, because it should act like `foo/ref2/ref3/ref1 A B C`.
//
// The current trick for solving this efficiently involves exploiting the
// fact that refinements in exemplar frames are nominally only unspecialized
// (null), in use (LOGIC! true) or disabled (LOGIC! false).  So a REFINEMENT!
// is put in refinement slots that aren't fully specialized, to give a partial
// that should be pushed to the top of the list of refinements in use.
//
// Mechanically it's "simple", but may look a little counterintuitive.  These
// words are appearing in refinement slots that they don't have any real
// correspondence to.  It's just that they want to be able to pre-empt those
// refinements from fulfillment, while pushing to the in-use-refinements stack
// in reverse order given in the specialization.
//
// More concretely, the exemplar frame slots for `foo23: :foo/ref2/ref3` are:
//
// * REF1's slot would contain the REFINEMENT! ref3.  As Eval_Core_Throws()
//   traverses arguments it pushes ref3 as the current first-in-line to take
//   arguments at the callsite.  Yet REF1 has not been "specialized out", so
//   a call like `foo23/ref1` is legal...it's just that pushing ref3 from the
//   ref1 slot means ref1 defers gathering arguments at the callsite.
//
// * REF2's slot would contain the REFINEMENT! ref2.  This will push ref2 to
//   now be first in line in fulfillment.
//
// * REF3's slot would hold a null, having the typical appearance of not
//   being specialized.
//
</code></pre>
<h2><a name="p-8098-if-you-dont-understand-that-dont-worry-about-trying-1" class="anchor" href="9.html#p-8098-if-you-dont-understand-that-dont-worry-about-trying-1"></a>If You Don't Understand That, Don't Worry About Trying</h2>
<p>It's building a data structure inside the refinement slots that jumbles the order and has to be unpacked during traversal... <em>it's not worth it</em>.</p>
<p>Anyway, I was testing the bootstrap executable and hit a bug in this stuff and said "Oh, screw it, I'm ripping this all out."</p>
<p><strong>Refinements just being their arguments... with ~null~ antiforms as the state of being not in use... is so much easier to implement, and ergonomic to use.</strong></p>
<h2><a name="p-8098-the-feature-we-dont-have-today-is-refinement-promotionhttpsrebolmetaeducationcomtsimplifying-refinement-promotion2338-2" class="anchor" href="9.html#p-8098-the-feature-we-dont-have-today-is-refinement-promotionhttpsrebolmetaeducationcomtsimplifying-refinement-promotion2338-2"></a>The Feature We Don't Have Today Is <a href="../../simplifying-refinement-promotion/2338.html">Refinement Promotion</a></h2>
<p>What the old code could do (sort of) which we can't do today is transform a refinement into an ordinary argument.</p>
<pre><code>apd: append:dup/
[a b c d e d e] = apd [a b c] [d e] 2
</code></pre>
<p>It's a valid desire, and things are in a better position to do it correctly and clearly.  But the old implementation was no good, even if it showed some decent results.</p>
<p>So here are some tests that aren't going to work any more, ever, in the bootstrap executable:</p>
<pre><code>foo: func [/A aa /B bb /C cc] [  ; Note: was before refinements were null
    return compose [
        (maybe any [A]) (maybe aa)  ; ANY makes blanks into nulls
        (maybe any [B]) (maybe bb) 
        (maybe any [C]) (maybe cc)
    ]
]

fooBC: :foo/B/C
fooCB: :foo/C/B
    
did all [ 
    [/B 10 /C 20] = fooBC 10 20
    [/A 30 /B 10 /C 20] = fooBC/A 10 20 30

    [/B 20 /C 10] = fooCB 10 20
    [/A 30 /B 20 /C 10] = fooCB/A 10 20 30

    error? sys/util/rescue [fooBC/B 1 2 3 4 5 6]
    error? sys/util/rescue [fooBC/C 1 2 3 4 5 6]
    error? sys/util/rescue [fooCB/B 1 2 3 4 5 6]
    error? sys/util/rescue [fooCB/C 1 2 3 4 5 6]
]
</code></pre>
<p>Here is another one:</p>
<pre><code>apd: specialize 'append/part [dup: true]
apd3: specialize 'apd [count: 3]
ap2d: specialize 'apd [limit: 2]

xy: [&lt;X&gt; #Y]
abc: [A B C]
r: [&lt;X&gt; #Y A B A B A B]

did all [
    r = apd copy xy abc 2 3
    r = applique 'apd [series: copy xy  value: abc  limit: 2  count: 3]

    r = apd3 copy xy abc 2
    r = applique 'apd3 [series: copy xy  value: abc  limit: 2]

    r = ap2d copy xy abc 3
    r = applique 'ap2d [series: copy xy  value: abc  count: 3]
]
</code></pre>
<p>And another:</p>
<pre><code>ap10d: specialize 'append/dup [value: 10]
f: make frame! :ap10d
f/series: copy [a b c]
did all [
    [a b c 10] = eval copy f
    f/count: 2
    [a b c 10 10 10] = eval f
]
</code></pre>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>

          </div>
    </div>

      <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
          <span itemprop='name'>
            <a itemprop="url" href="../1120.html#post_9">show post in topic</a>
          </span>
      </div>

    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/categories' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='https://rebol.metaeducation.com/guidelines' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://rebol.metaeducation.com/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://rebol.metaeducation.com/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    
  </body>
  
</html>
